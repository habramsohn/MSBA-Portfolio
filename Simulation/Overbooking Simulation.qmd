```{r}
#| message: false
#| warning: false
rm(list=ls())
library(ggthemes)
library(tidyverse)
library(gt)

options(scipen = 999)
```

Airlines commonly sell more seats than exist on a plane, a practice known as 'overbooking', to prevent no-show passengers from lowering the utilization of seats. To help an airline pick the ideal number of overbooked seats per flight, we'll simulate different scenarios according to the following parameters:

1. The number of no-show passengers per flight follows a normal distribution with a mean of 20 and a standard deviation of 5. 
2. Failing to fill a seat carries an estimated opportunity cost of USD 300. 
3. Compensating a bumped passenger - whose seat was overbooked - costs a USD 600 voucher.

We will run 10,000 simulations calculating the losses of overbooking 10-30 seats, in increments of 1, to pick the number minimizing total cost. 

```{r}
nsim = 10000
mean = 20
sd = 5
unused_seat_cost = 300
vouchers = 600
poss_values = 10:30

sim <- tibble(
  sim = rep(1:nsim, each = length(poss_values)),
  PossibleValues = rep(poss_values, times = nsim),
  NoShows = round(rnorm(nsim * length(poss_values), mean = mean, sd = sd)), 
  Cost = case_when(
    NoShows > PossibleValues ~ (NoShows - PossibleValues) * unused_seat_cost, 
    NoShows < PossibleValues ~ (PossibleValues - NoShows) * vouchers, 
    T ~ 0))                                                                 

sim %>%
  group_by(PossibleValues) %>%
  summarise(S.Cost = mean(Cost)) %>%
  gt() %>%
  tab_style(
    style = cell_fill(color = "#3498db"),
    locations = cells_body(
      columns = S.Cost,
      rows = S.Cost == min(S.Cost)))

expected_costs <- sim %>%
  group_by(PossibleValues) %>%
  summarise(Expected_Cost = mean(Cost)) %>%
  ungroup() 

optimal <- expected_costs %>%
  filter(Expected_Cost == min(Expected_Cost))

sim_hist <- sim %>%
    group_by(PossibleValues) %>%
    summarise(S.Cost = mean(Cost)) %>%
    mutate(highlight_flag = ifelse(S.Cost == min(S.Cost), "Target", "Other")) %>%
    ggplot(aes(x = factor(PossibleValues), y = S.Cost, fill = highlight_flag)) +
    scale_fill_manual(values = c("Target" = "#3498db", "Other" = "#d3d3d3")) +
    geom_col(show.legend = FALSE) +
    labs(
        x = "Number of Overbooked Seats",
        y = "Cost",
        title = "Cost per Number of Overbooked Seats")

sim_hist
```

